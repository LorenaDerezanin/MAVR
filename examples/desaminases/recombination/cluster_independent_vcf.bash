#!/usr/bin/env bash
#SBATCH --array=1-63%63
#SBATCH -n 2
#SBATCH --time=100:00:00          # Run time in hh:mm:ss
#SBATCH --mem-per-cpu=4096       # Minimum memory required per CPU (in megabytes)
#SBATCH --job-name=clustering_sets
#SBATCH --error=/work/pavlov/okochenova/clustering_per_sample/clustering.%A_%a.err
#SBATCH --output=/work/pavlov/okochenova/clustering_per_sample/clustering.%A_%a.out

module load compiler/gcc/4.8 python/2.7

source /work/pavlov/okochenova/profile

WORK=/work/pavlov/okochenova/
CLUSTERING_SCRIPT=${WORK}soft/MACE/scripts/clustering_pipeline.py
THRESHOLD_SCRIPT=${WORK}soft/MACE/scripts/test_clustering_thresholds.py

WORKDIR=${WORK}clustering_per_sample/
VCF_DIR=${WORK}/per_sample_vcf/


REFERENCE=/work/pavlov/okochenova/reference/LAN210/LAN210_v0.10m/LAN210_v0.10m.fasta
REFERENCE_ANNOTATIONS=/work/pavlov/okochenova/reference/LAN210/LAN210_v0.10m/merged_annotations_Nagalakshmi_tranf_to_LAN210_v0.10m.gff3
REFERENCE_MASKING=/work/pavlov/okochenova/reference/LAN210/LAN210_v0.10m/LAN210_v0.10m_masked_all_not_in_good_genes.gff

SAMPLE_SETS=(N010-LAN210-Can-PmCDA1-NA-RUN2-D3 N092-LAN210-Can-PmCDA1-NA-RUN7-D6 N011-LAN210-Can-PmCDA1-NA-RUN2-D3 N093-LAN210-Can-PmCDA1-NA-RUN7-D6 N012-LAN210-Can-PmCDA1-NA-RUN2-D3 N094-LAN210-Can-PmCDA1-NA-RUN7-D6 N013-LAN210-Can-PmCDA1-NA-RUN2-D3 N095-LAN210-Can-PmCDA1-NA-RUN7-D6 N034-LAN210-Can-A1-Oct12-RUN4-D3 N096-LAN210-Can-PmCDA1-NA-RUN7-D6 N035-LAN210-Can-A1-Oct12-RUN4-D3 N097-LAN210-Can-AID-NA-RUN7-D1 N036-LAN210-FOA-A1-Oct12-RUN4-D3 N098-LAN210-Can-AID-NA-RUN7-D1 N037-LAN210-FOA-A1-Oct12-RUN4-D3 N100-LAN210-Can-AID-NA-RUN7-D3 N040-LAN210-Can-AID-Oct12-RUN4-D3 N101-LAN210-Can-AID-NA-RUN7-D3 N041-LAN210-Can-AID-Oct12-RUN4-D3 N102-LAN210-Can-AID-NA-RUN7-D3 N058-LAN210-Can-PmCDA1-Feb13-RUN5-D3 N103-LAN210-Can-AID-NA-RUN7-D6 N059-LAN210-FOA-PmCDA1-Feb13-RUN5-D3 N104-LAN210-Can-AID-NA-RUN7-D6 N060-LAN210-FOA-PmCDA1-Feb13-RUN5-D3 N105-LAN210-Can-AID-NA-RUN7-D6 N061-LAN210-Can-PmCDA1-NA-RUN5-D3 N106-LAN210-Can-AID-NA-RUN7-D6 N062-LAN210-Can-PmCDA1-NA-RUN5-D3 N107-LAN210-Can-A1-NA-RUN7-D1 N065-LAN210-Can-PmCDA1-NA-RUN6-D3 N108-LAN210-Can-A1-NA-RUN7-D1 N066-LAN210-Can-PmCDA1-NA-RUN6-D3 N109-LAN210-Can-A1-NA-RUN7-D1 N070-LAN210-Can-PmCDA1-NA-RUN6-D6 N110-LAN210-Can-A1-NA-RUN7-D1 N071-LAN210-Can-PmCDA1-NA-RUN6-D6 N111-LAN210-Can-A1-NA-RUN7-D1 N072-LAN210-Can-PmCDA1-NA-RUN6-D6 N112-LAN210-Can-A1-NA-RUN7-D1 N073-LAN210-Can-PmCDA1-NA-RUN6-D6 N113-LAN210-Can-A1-NA-RUN7-D3 N077-LAN210-Can-AID-NA-RUN6-D6 N114-LAN210-Can-A1-NA-RUN7-D3 N078-LAN210-Can-AID-NA-RUN6-D6 N115-LAN210-Can-A1-NA-RUN7-D3 N079-LAN210-Can-A1-NA-RUN6-D6 N116-LAN210-Can-A1-NA-RUN7-D3 N080-LAN210-Can-A1-NA-RUN6-D6 N117-LAN210-Can-A1-NA-RUN7-D3 N085-LAN210-Can-PmCDA1-NA-RUN7-D1 N118-LAN210-Can-A1-NA-RUN7-D3 N086-LAN210-Can-PmCDA1-NA-RUN7-D1 N120-LAN210-Can-A1-NA-RUN7-D6 N087-LAN210-Can-PmCDA1-NA-RUN7-D1 N121-LAN210-Can-A1-NA-RUN7-D6 N088-LAN210-Can-PmCDA1-NA-RUN7-D1 N122-LAN210-Can-A1-NA-RUN7-D6 N089-LAN210-Can-PmCDA1-NA-RUN7-D1 N123-LAN210-Can-A1-NA-RUN7-D6 N090-LAN210-Can-PmCDA1-NA-RUN7-D1 N124-LAN210-Can-A1-NA-RUN7-D6 N091-LAN210-Can-PmCDA1-NA-RUN7-D3)

cd ${WORKDIR}

SAMPLE_SET_INDEX=
let "SAMPLE_SET_INDEX=${SLURM_ARRAY_TASK_ID}-1"
CURRENT_SAMPLE_SET=${SAMPLE_SETS[${SAMPLE_SET_INDEX}]}
mkdir -p ${CURRENT_SAMPLE_SET}
cd ${CURRENT_SAMPLE_SET}
echo ${CURRENT_SAMPLE_SET}

CURRENT_VCF=${VCF_DIR}${CURRENT_SAMPLE_SET}.vcf

THRESHOLD_STR="${THRESHOLD_SCRIPT} -i ${CURRENT_VCF} -s ${CURRENT_SAMPLE_SET} -e distance -d average -n 50 -x 5000 -u 100"
echo ${THRESHOLD_STR}
${THRESHOLD_STR}
CLUSTERING_STR="${CLUSTERING_SCRIPT} -r ${REFERENCE} -a ${REFERENCE_ANNOTATIONS} -m ${REFERENCE_MASKING} -f ${CURRENT_VCF} -s ${CURRENT_SAMPLE_SET} -y clustering/"
echo ${CLUSTERING_STR}
${CLUSTERING_STR}
